---
title: "Supplementary Information for:"
subtitle: A dynamic bioenergetic model for coral-*Symbiodinium* symbioses and coral bleaching as an alternate stable state
author: "Ross Cunning, Erik B. Muller, Ruth D. Gates, Roger M. Nisbet"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    toc_depth: 1
bibliography: library.bib
---

-----

This supplement provides justification and derivations from the literature for all parameter values used in the model, as well as additional figures that demonstrate the structure and behavior of the model and its specific components. R code for each chunk of output in this document can be shown and hidden using the right-aligned "Code" buttons, or for the entire document using the button at the top. This HTML output was knit from an RMarkdown document that can be found [here](https://github.com/jrcunning/coRal-analysis/blob/master/supp/supp.Rmd).

```{r setup, include=FALSE}
require(pander)
require(stringr)
require(coRal)
knitr::opts_knit$set(root.dir = normalizePath(".."))
knitr::opts_chunk$set(message = F, warning = F, echo=T, results='asis')
knitr::opts_chunk$set(results = "asis", render=pander, cache=T)
```

```{r initialize, include=FALSE}
# Source default parameters and functions
sapply(c("R/run_steady_states.R", "R/plot_steady_states.R", "R/reported_metrics.R",
         "R/sensitivity.R", "R/conversions.R"), source, .GlobalEnv)
# Get default parameters
defpars <- coRal::def_pars()
```

-----

# Model parameters
All parameters in the model are listed here along with the relevant literature that provides a basis for the value used. In most cases, the units of the values reported in the literature were converted to units appropriate for the model, which was accomplished using a consistent set of stoichiometric conversion factors also based on reported literature (see [Conversion factors used in parameter derivation]). Calculations executed in R are shown for each parameter (when relevant) as well as the final value used.

## Parameter value derivations

#### $n_{NH}$: N:C molar ratio in host biomass {-}
@Horwitz:2015cf measured a molar C:N ratio of 5.53 in anemones under control conditions, which converts to:
```{r nNH}
1 / 5.53
```
N:C ratio (dimensionless)
<br><br>

#### $n_{NS}$: N:C molar ratio in symbiont biomass {-}
This value should approximate the Redfield ratio (following @Muller:2009io).  
```{r nNS, echo=F}
0.13
```
N:C ratio (dimensionless)
<br><br> 
    
#### $n_{NX}$: N:C molar ratio in prey biomass {-}
Assuming the coral feeds primarily on zooplankton, a general heterotroph has a molar N:C ratio of 0.2 [@Muller:2009io].  
```{r nNX, echo=F}
0.20
```
N:C ratio (dimensionless)
<br><br>

#### $j_{HT}^0$: Specific turnover rate of host biomass {-}
@Jacobson:2016bk parameterized a DEB model for coral symbiosis, and reported a specific maintenance rate of 0.03 mol C~E~ mol C~V~^-1^ d^-1^, where subscripts E and V refer to reserve and structural biomass. We assume (simplistically) the same rate per unit of total biomass:  
```{r jHT, echo=F}
0.03
```
C-mol H C-mol H^-1^ d^-1^
<br><br>

#### $j_{ST}^0$: Specific turnover rate of symbiont biomass {-}
Values of *Symbiodinium* and other dinoflagellate respiration rates may provide a reasonable approximation of the specific turnover rate of symbiont biomass, yet values calculated from various studies range widely from 0.01 to nearly 0.2. Without data for a more confident estimation of this parameter, we choose a value at the low end of this range, since 0.2 seems unrealistic and many rates may be depressed in symbiotic dinoflagellates relative to their free-living counterparts.  
```{r jST, echo=F}
0.03
```
C-mol S C-mol S^-1^ d^-1^  
<br><br>

#### $\sigma_{NH}, \sigma_{NS}$: Proportions of nitrogen recycled from host and symbiont biomass turnover {-}
Assume highly efficient recycling by both symbiont and host to avoid loss to the environment:  
```{r sigmaNHsigmaNS, echo=F}
c(0.9, 0.9)
```
(dimensionless)
<br><br>

#### $\sigma_{CS}$: Proportion of metabolic CO~2~ produced by symbiont recycled passively to photosynthesis {-}
Assume that CO~2~ produced within symbiont cells is recycled with high efficiency, potentially aided by symbiont carbon concentrating mechanisms:  
```{r sigmaCS, echo=F}
0.9
```
(dimensionless)
<br><br>

#### $\sigma_{CH}$: Proportion of metabolic CO~2~ produced by host recycled passively to photosynthesis {-}
Assume that most metabolic CO~2~ produced within host cells rapidly converts to HCO~3~^-^ at intracellular pH ~ 7.2 [@Venn:2009hy], and that only ~10% actually remains as CO~2~ [@Zeebe:2001wz] that could diffusively supply photosynthesis. This passive supply is differentiated from all active host carbon concentrating mechanisms (CCMs) that facilitate CO~2~ supply to photosynthesis, which are separately treated collectively as the $j_{CO_2}$ flux.  
```{r sigmaCH, echo=F}
0.1
```
(dimensionless)
<br><br>    

#### $j_{Xm}$: Maximum specific rate of assimilation from host feeding {-}
@Wijgerde:2011du measured depletion of carbon from captured prey in *Galaxea fascicularis* (including both intracoelenteric and extracoelenteric feeding), reporting a maximum specific carbon assimilation rate of 77.6 µgC cm^-2^ 6h^-1^, which converts to:  
```{r jXm}
77.6 / µg.g / gC.molC * cm2.m2 / CmolR.m2_Gfas * 24/6
```
C-mol X C-mol H^-1^ d^-1^
<br><br>


#### $K_X$: Half-saturation constant of assimilation from host feeding {-}
For consistency, and due to a lack of available data, we use the same value as @Muller:2009io :  
```{r KX}
1e-6
```
C-mol X L^-1^
<br><br>

#### $j_{Nm}$: Maximum specific DIN uptake rate by host {-}
@Muscatine:1978fa measured ammonium uptake in 3 coral species and reported an average value of 7.22 µmol NH~4~^+^-N mg chl *a*^-1^ h^-1^ (Table 1, uncorrected), which converts to:
```{r jNm1}
7.22 * h.d * nmolchlA.cm2 * gchlA.molchlA * mg.g / nmol.mol / CmolR.m2_Spis * cm2.m2 / µmol.mol
```
mol N C-mol H^-1^ d^-1^  
<br>
@HoeghGuldberg:1999p3974 measured ammonium and dissolved free amino acid uptake in *Pocillopora damicornis* and reported a maximum rate of 91.8 nmol N cm^-2^ h^-1^, which converts to:
```{r jNm2}
91.8 * h.d * cm2.m2 / CmolR.m2_Spis / nmol.mol
``` 
mol N C-mol H^-1^ d^-1^  
<br>
@Godinot:2011jg measured nitrate and ammonium uptake rates in *Stylophora pistillata* under high nutrient concentrations and reported a maximum value of 3.5 µmolN mg chl^-1^ d^-1^ [addition of bars in Fig. 4D,E @ 29°C], which converts to:
```{r jNm3}
3.5 * h.d * 22 / CmolR.m2_Spis * cm2.m2 / µmol.mol / 1000
```
mol N C-mol H^-1^ d^-1^   
<br>
@Godinot:2011bm measured ammonium uptake kinetics in *Stylophora pistillata* and reported a maximum rate of 5.42 molN mg chl^-1^ h^-1^, which converts to:
```{r jNm4}
5.42 * h.d * µgchl.cm2_Spis / CmolR.m2_Spis * cm2.m2 / µmol.mol / 1000
```
mol N C-mol H^-1^ d^-1^   
<br>
Averaging these reported values, we arrive at:  
```{r jNm_avg, echo=F}
round(mean(c(7.22 * h.d * nmolchlA.cm2 * gchlA.molchlA * mg.g / nmol.mol / CmolR.m2_Spis * cm2.m2 / µmol.mol, 91.8 * h.d * cm2.m2 / CmolR.m2_Spis / nmol.mol, 3.5 * h.d * 22 / CmolR.m2_Spis * cm2.m2 / µmol.mol / 1000, 5.42 * h.d * µgchl.cm2_Spis / CmolR.m2_Spis * cm2.m2 / µmol.mol / 1000)), 3)
```
mol N C-mol H^-1^ d^-1^
<br><br>

#### $K_N$: Half-saturation constant for DIN uptake by host {-}
@Muscatine:1978fa measured ammonium uptake in 3 coral species and reported an average half-saturation constant of 1.84 µmolN L^-1^ (Table 1, uncorrected).  
@Godinot:2011bm measured ammoinum uptake kinetics in *Stylophora pistillata* and reported a half-saturation constant of 0.46 µmol N L^-1^.  
Averaging these reported values (weighted by number of species measured), we arrive at:  
```{r KN}
(1.84*3 + 0.46*1)/4
``` 
mol N L^-1^
<br><br>

#### $k_{CO_2}$: Efficacy of CO~2~ delivery by host CCMs {-}
This parameter represents the relative amount of CO~2~ that can be delivered by the host to photosynthesis given the reducing power generated from 1 mol of fixed carbon. We assume that the host uses a portion of its fixed carbon to generate ATP which is then used to activate a variety of carbon concentrating mechanisms (see @Wooldridge:2013tj). We assume these CCMs are efficient and can deliver an order of magnitude more CO~2~ relative to the fixed carbon available:  
```{r kCO2, echo=F}
10
```
mol CO~2~ mol C^-1^
<br><br>

#### $j_{HGm}$: Maximum specific growth rate of host {-}
We set this to a high value such that constraints on growth are primarily determined by substrate availabilities rather than the maximum value:  
```{r jHGm, echo=F}
1
```
C-mol H C-mol H^-1^ d^-1^
<br><br>

#### $y_{CL}$: Quantum yield of photosynthesis {-}
The maximum theoretical quantum yield is 0.125 mol C fixed per mol photons. @Brodersen:2014gw presented a balanced light budget based on microenvironmental photobiology of *Montastrea curta*, and reported a quantum yield of 0.102 O~2~ photon^-1^:  
```{r yCL, echo=F}
0.1
```
mol C mol photons^-1^
<br><br>

#### $y_{C}$: Yield of biomass formation from photosynthate {-}
This coefficient specifies the efficiency of conversion of photosynthate into biomass at the biomass synthesizing units, which combine photosynthate (CH~2~O), ammonia (NH~3~) and O~2~ to form biomass, water, and CO~2~. Because of thermodynamic constraints, there is an energetic overhead on converting carbon into biomass. In order to balance this macrochemical equation, there must be a carbon loss, which is accounted for using $y_{C}$ < 1. We take a value of 0.8 following @Muller:2009io :  

```{r yC, echo=F}
0.8
```
C-mol mol C^-1^

If $y_C$ represents the yield (in C-mol) of biomass per C-mol photosynthate, we assume that the energetic cost of this conversion, met from respiration, will lead to simultaneous production of $(1 – y_C)$ C-mol of CO~2~. Thus the ratio of the overhead contribution to CO~2~ flux to the growth flux is $(1 – y_C)/y_C$, and hence the CO~2~ flux ($j_{CO_2}$) can be specified in terms of the growth flux ($j_G$) as $j_{CO_2} = {(1-y_C) j_G \over y_C}$ (see equations 13 and 14 in the main text).
<br><br>

#### $\bar{a}^*$: Effective light-absorbing cross-section of symbiont {-}
@Hennige:2009p3439 measured spectra-weighted absoprtion coefficients from 400 to 700nm *ā\**~(400-700)~ for eight *Symbiodinium* types in culture at two different light levels, and reported a (grand mean) value of 0.01095 m^2^ mg chl *a*^-1^ [from Table 6]. This converts to:
```{r astar}
0.01095 * mg.g * gchlA.gC * gC.molC
```
m^2^ C-mol S^-1^
<br><br>

#### $k_{NPQ}$: Capacity of non-photochemical quenching {-}
@Gorbunov:2001p4181 report that the capacity of non-photochemical quenching is approximately 4 times the capacity of photochemistry on a sunny day. Therefore, we take the maximum relative capacity of NPQ to be 4 times the maximum rate of photochemical quenching ($j_{CPm}$; see below), giving a value of:
```{r kNPQ}
defpars$jCPm / defpars$yCL * 4
```
mol photons C-mol S^-1^ d^-1^
<br><br>

#### $k_{ROS}$: Amount of excitation energy not quenched by photoehcemistry or NPQ that doubles relative production of ROS {-}
@McGinty:2012ck report a ~4-fold increase in ROS production in *Symbiodinium* C1 under stressful conditions relative to control. We chose a value of $k_{ROS}$ that similarly produced a ~4-fold increase in ROS production at the highest light level (see Figure S2):  
```{r kROS, echo=F}
80
```
mol photons C-mol S^-1^ d^-1^
<br><br>    

#### $j_{CPm}$: Maximum specific photosynthesis rate of symbiont {-}
In theory, this value should be the maximum carboxylation rate of *Symbiodinium* Rubisco (RuBP). @Leggat:2004vx report a maximum carboxylation rate at 29°C of 140 CO~2~ RuBP^-1^ s^-1^ [Max. value, p. 143], which converts to:  
```{r jCPm}
140 * s.h * h.d * RuBP.CmolS
```
mol C C-mol S^-1^ d^-1^
<br><br>

#### $j_{SGm}$: Maximum specific growth rate of symbiont {-}
We use the maximum specific growth rate of *Symbiodinium* that is reported by @Chang:1983p8066 :  
```{r jSGm, echo=F}
0.25
```
C-mol S C-mol S^-1^ d^-1^
<br><br>

#### $b$: Scaling parameter for strength of bleaching response {-}
This value determines the magnitude of symbiont biomass loss (considered as expulsion of symbionts during bleaching) in response to ROS. In this context, relative ROS concentrations are assumed to trigger symbiont expulsion via unknown signaling mechanisms. Larger values of this parameter cause greater biomass loss in response to ROS signaling (i.e., a more severe bleaching response). Since this represents symbionts being expelled from the system, we use a value about two orders of magnitude higher than the turnover rate due to maintenance:  
```{r b, echo=F}
5
```
(dimensionless)
<br><br>

## Conversion factors used in parameter derivation
```{r, code = readLines('../R/conversions.R')}
```

------

# Figure S1 
```{r lightamp, fig.width=5, fig.height=5, eval=T, include=T, fig.cap="**Fig. S1. Light amplification and self-shading.** The amplification factor (A) is the ratio of internal scalar irradiance experienced by *Symbiodinium* to the external downwelling irradiance, and is greater than 1 due to multiple scattering of incident light by the coral skeleton. The amplification factor decreases as a function of symbiont abundance (converted to symbiont to host biomass ratio) due to self-shading. Data are from Marcelino et al. (2013) using skeletons from three different coral species: pdam=*Pocillopora damicornis*; plob=*Porites lobata*; shys=*Seriatopora hystrix*."}

# Import data from Marcelino et al. 2013
md <- read.csv("data/marcelino2013_fig2a.csv")
md$S.H <- md$density * cm2.m2 / CmolR.m2 * CmolS.cellS  # Convert units of symbiont density to CmolS/CmolR
md$A <- md$E + 1  # Convert "E"=excess light metric of Marcelino to "A"=amplification factor
# Plot data
par(mfrow=c(1,1), mar=c(3,3,3,3), mgp=c(1.2,0,0), cex=1, tck=0.025)
plot(md$A ~ md$S.H, pch=c(21,23,22)[factor(md$spp)], bg=c("white", "black", "gray")[factor(md$spp)], 
     ylab="A (Amplification factor)", ylim=c(1,3.2),
     xlab="S:H biomass")
legend("topright", legend=levels(md$spp), pch=c(21,23,22), pt.bg=c("white", "black", "gray"), inset=0.02)
# Fit exponential decay model and plot fitted values
mod <- nls(A ~ x + y * exp(z * S.H), data=md, start=list(x=1, y=2, z=-3))
fit <- predict(mod, list(S.H=seq(0, 0.5, 0.01)))
lines(fit ~ seq(0, 0.5, 0.01))
# Get parameters of fit and add to plot
coefs <- round(coef(mod), 2)
fiteq <- str_replace_all(format(formula(mod)), c("~"="= ", " x"=coefs[[1]], "y"=coefs[[2]], "z"=coefs[[3]]))
text(0.05,2.8, fiteq, adj=0)


```

-----

# Figure S2 
```{r run1_PI, cache=F, fig.height=4, fig.width=7, fig.cap="**Fig. S2. Photosynthesis-Irradiance curves of modeled symbiont.** The rates of light energy quenching through photochemistry (red line) and non-photochemical quenching (black line), and the relative production of reactive oxygen species (orange line) are plotted as a function of the scalar irradiance experienced by the symbiont (note different y-axes for each line). These curves represent the behavior of the photosynthesis SU independent of the host and without CO~2~ limitation of photosynthesis (*j~CO2~* set to a very high value). The structure of the photosynthesis SU, with the negative feedback between excess light and photosynthesis rate, produces the classic shape of a P-I curve demonstrating photoinhibition, suggesting the mechanism is robust."}
sympi <- sym_PI(pars=def_pars())
```

-----

# Figure S3 
```{r sens_ILHN, cache=T, eval=T, fig.cap="**Fig. S3. Sensitivity analysis under high DIN (4e-6 M) and intermediate light (20 mol m^-2^ d^-1^).** See Fig. 4 in main text."}
# Set up time vector and parameters
defpars <- def_pars()  # Get default parameters
defpars <- replace(defpars, "initS", 1)  # Start with high S biomass to avoid alternate steady state of negative growth

# Define environments for conducting sensitivity analysis
envs <- list(
  ILHN=list(L=20, N=4e-6, X=0)
)

# Define relative changes in each parameter to evaluate
levs <- seq(0.5, 1.5, 0.05)  # Set levels of % change in parameter value to evaluate

# Define all simulations to be run for a given parameter
sims <- expand.grid(env=names(envs), change=levs)
n <- nrow(sims)

# Set up cluster for parallel processing
cl <- makeCluster(detectCores())  # Initiate cluster
registerDoParallel(cl)

# Run sensitivity analysis in each environment for each parameter
jHT0.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jHT0", change=change))
jNm.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jNm", change=change))
jHGm.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jHGm", change=change))
kCO2.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="kCO2", change=change))
KN.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="KN", change=change))
jST0.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jST0", change=change))
kNPQ.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="kNPQ", change=change))
kROS.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="kROS", change=change))
astar.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="astar", change=change))
jCPm.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jCPm", change=change))
jSGm.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jSGm", change=change))
b.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="b", change=change))

stopCluster(cl)  # Stop cluster

# Combine output with input
sens.all <- ls(pattern="*.sens")
for (i in 1:length(sens.all)) {
  assign(sens.all[i], cbind(sims, get(sens.all[i])))
}

# When growth rate becomes negative, set all responses to NA
for (i in 1:length(sens.all)) {
  if (any(get(sens.all[i])$grchange < 0, na.rm=T)) {
    assign(sens.all[i], within(get(sens.all[i]), {
      shchange <- replace(shchange, grchange < 0, NA)
      cROSchange <- replace(cROSchange, grchange < 0, NA)
      grchange <- replace(grchange, grchange < 0, NA)
    }))
  }
}

# Plot Figure
par(mfrow=c(2,2), mar=c(3,3,1,1), mgp=c(2,0.5,0))
sens.plot(response=c("grchange", "shchange"), pars=c("jCPm", "kCO2", "astar"), cols=c("black", "red", "gold"))
sens.plot(response=c("grchange", "shchange"), pars=c("jNm", "KN"), cols=c("black", "blue"))
sens.plot(response=c("grchange", "shchange"), pars=c("jST0", "jHT0", "jSGm", "jHGm"), cols=c("burlywood4", "burlywood3", "darkolivegreen4", "darkolivegreen3"))
sens.plot(response=c("grchange", "shchange"), pars=c("kNPQ", "kROS", "b"), cols=c("black", "orange", "purple"))
```

-----

# Figure S4 
```{r sens_LLLN, cache=T, eval=T, fig.cap="**Sensitivity analysis under low DIN (1e-7 M) and low light (5 mol m^-2^ d^-1^).** See Fig. 4 in main text."}
# Set up time vector and parameters
defpars <- def_pars()  # Get default parameters
defpars <- replace(defpars, "initS", 1)  # Start with high S biomass to avoid alternate steady state of negative growth

# Define environments for conducting sensitivity analysis
envs <- list(
  LLLN=list(L=5, N=1e-7, X=0)
)

# Define relative changes in each parameter to evaluate
levs <- seq(0.5, 1.5, 0.05)  # Set levels of % change in parameter value to evaluate

# Define all simulations to be run for a given parameter
sims <- expand.grid(env=names(envs), change=levs)
n <- nrow(sims)

# Set up cluster for parallel processing
cl <- makeCluster(detectCores())  # Initiate cluster
registerDoParallel(cl)

# Run sensitivity analysis in each environment for each parameter
jHT0.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jHT0", change=change))
jNm.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jNm", change=change))
jHGm.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jHGm", change=change))
kCO2.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="kCO2", change=change))
KN.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="KN", change=change))
jST0.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jST0", change=change))
kNPQ.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="kNPQ", change=change))
kROS.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="kROS", change=change))
astar.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="astar", change=change))
jCPm.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jCPm", change=change))
jSGm.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jSGm", change=change))
b.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="b", change=change))

stopCluster(cl)  # Stop cluster

# Combine output with input
sens.all <- ls(pattern="*.sens")
for (i in 1:length(sens.all)) {
  assign(sens.all[i], cbind(sims, get(sens.all[i])))
}

# When growth rate becomes negative, set all responses to NA
for (i in 1:length(sens.all)) {
  if (any(get(sens.all[i])$grchange < 0, na.rm=T)) {
    assign(sens.all[i], within(get(sens.all[i]), {
      shchange <- replace(shchange, grchange < 0, NA)
      cROSchange <- replace(cROSchange, grchange < 0, NA)
      grchange <- replace(grchange, grchange < 0, NA)
    }))
  }
}

# Plot Figure
par(mfrow=c(2,2), mar=c(3,3,1,1), mgp=c(2,0.5,0))
sens.plot(response=c("grchange", "shchange"), pars=c("jCPm", "kCO2", "astar"), cols=c("black", "red", "gold"))
sens.plot(response=c("grchange", "shchange"), pars=c("jNm", "KN"), cols=c("black", "blue"))
sens.plot(response=c("grchange", "shchange"), pars=c("jST0", "jHT0", "jSGm", "jHGm"), cols=c("burlywood4", "burlywood3", "darkolivegreen4", "darkolivegreen3"))
sens.plot(response=c("grchange", "shchange"), pars=c("kNPQ", "kROS", "b"), cols=c("black", "orange", "purple"))
```

-----

# Figure S5
```{r sens_LLHN, cache=T, eval=T, fig.cap="**Fig. S5. Sensitivity analysis under high DIN (4e-6 M) and low light (5 mol m^-2^ d^-1^).** See Fig. 4 in main text. Open circles represent points at which the parameter value causes the system to move into the negative growth stable state."}
# Set up time vector and parameters
defpars <- def_pars()  # Get default parameters
defpars <- replace(defpars, "initS", 1)  # Start with high S biomass to avoid alternate steady state of negative growth

# Define environments for conducting sensitivity analysis
envs <- list(
  LLHN=list(L=5, N=4e-6, X=0)
)

# Define relative changes in each parameter to evaluate
levs <- seq(0.5, 1.5, 0.05)  # Set levels of % change in parameter value to evaluate

# Define all simulations to be run for a given parameter
sims <- expand.grid(env=names(envs), change=levs)
n <- nrow(sims)

# Set up cluster for parallel processing
cl <- makeCluster(detectCores())  # Initiate cluster
registerDoParallel(cl)

# Run sensitivity analysis in each environment for each parameter
jHT0.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jHT0", change=change))
jNm.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jNm", change=change))
jHGm.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jHGm", change=change))
kCO2.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="kCO2", change=change))
KN.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="KN", change=change))
jST0.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jST0", change=change))
kNPQ.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="kNPQ", change=change))
kROS.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="kROS", change=change))
astar.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="astar", change=change))
jCPm.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jCPm", change=change))
jSGm.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jSGm", change=change))
b.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="b", change=change))

stopCluster(cl)  # Stop cluster

# Combine output with input
sens.all <- ls(pattern="*.sens")
for (i in 1:length(sens.all)) {
  assign(sens.all[i], cbind(sims, get(sens.all[i])))
}

# When growth rate becomes negative, set all responses to NA
for (i in 1:length(sens.all)) {
  if (any(get(sens.all[i])$grchange < 0, na.rm=T)) {
    assign(sens.all[i], within(get(sens.all[i]), {
      shchange <- replace(shchange, grchange < 0, NA)
      cROSchange <- replace(cROSchange, grchange < 0, NA)
      grchange <- replace(grchange, grchange < 0, NA)
    }))
  }
}

# Plot Figure
par(mfrow=c(2,2), mar=c(3,3,1,1), mgp=c(2,0.5,0))
sens.plot(response=c("grchange", "shchange"), pars=c("jCPm", "kCO2", "astar"), cols=c("black", "red", "gold"))
sens.plot(response=c("grchange", "shchange"), pars=c("jNm", "KN"), cols=c("black", "blue"))
sens.plot(response=c("grchange", "shchange"), pars=c("jST0", "jHT0", "jSGm", "jHGm"), cols=c("burlywood4", "burlywood3", "darkolivegreen4", "darkolivegreen3"))
sens.plot(response=c("grchange", "shchange"), pars=c("kNPQ", "kROS", "b"), cols=c("black", "orange", "purple"))
```

-----

# Figure S6
```{r sens_HLLN, cache=T, eval=T, fig.cap="**Fig. S6. Sensitivity analysis under low DIN (1e-7 M) and high light (30 mol m^-2^ d^-1^).** See Fig. 4 in main text. Open circles represent points at which the parameter value causes the system to move into the negative growth stable state."}
# Set up time vector and parameters
defpars <- def_pars()  # Get default parameters
defpars <- replace(defpars, "initS", 1)  # Start with high S biomass to avoid alternate steady state of negative growth

# Define environments for conducting sensitivity analysis
envs <- list(
  HLLN=list(L=30, N=1e-7, X=0)
)

# Define relative changes in each parameter to evaluate
levs <- seq(0.5, 1.5, 0.05)  # Set levels of % change in parameter value to evaluate

# Define all simulations to be run for a given parameter
sims <- expand.grid(env=names(envs), change=levs)
n <- nrow(sims)

# Set up cluster for parallel processing
cl <- makeCluster(detectCores())  # Initiate cluster
registerDoParallel(cl)

# Run sensitivity analysis in each environment for each parameter
jHT0.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jHT0", change=change))
jNm.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jNm", change=change))
jHGm.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jHGm", change=change))
kCO2.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="kCO2", change=change))
KN.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="KN", change=change))
jST0.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jST0", change=change))
kNPQ.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="kNPQ", change=change))
kROS.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="kROS", change=change))
astar.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="astar", change=change))
jCPm.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jCPm", change=change))
jSGm.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jSGm", change=change))
b.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="b", change=change))

stopCluster(cl)  # Stop cluster

# Combine output with input
sens.all <- ls(pattern="*.sens")
for (i in 1:length(sens.all)) {
  assign(sens.all[i], cbind(sims, get(sens.all[i])))
}

# When growth rate becomes negative, set all responses to NA
for (i in 1:length(sens.all)) {
  if (any(get(sens.all[i])$grchange < 0, na.rm=T)) {
    assign(sens.all[i], within(get(sens.all[i]), {
      shchange <- replace(shchange, grchange < 0, NA)
      cROSchange <- replace(cROSchange, grchange < 0, NA)
      grchange <- replace(grchange, grchange < 0, NA)
    }))
  }
}

# Plot Figure
par(mfrow=c(2,2), mar=c(3,3,1,1), mgp=c(2,0.5,0))
sens.plot(response=c("grchange", "shchange"), pars=c("jCPm", "kCO2", "astar"), cols=c("black", "red", "gold"))
sens.plot(response=c("grchange", "shchange"), pars=c("jNm", "KN"), cols=c("black", "blue"))
sens.plot(response=c("grchange", "shchange"), pars=c("jST0", "jHT0", "jSGm", "jHGm"), cols=c("burlywood4", "burlywood3", "darkolivegreen4", "darkolivegreen3"))
sens.plot(response=c("grchange", "shchange"), pars=c("kNPQ", "kROS", "b"), cols=c("black", "orange", "purple"))
```

-----

# Figure S7
```{r sens_HLHN, cache=T, eval=T, fig.cap="**Fig. S7. Sensitivity analysis under high DIN (4e-6 M) and high light (30 mol m^-2^ d^-1^).** See Fig. 4 in main text. Open circles represent points at which the parameter value causes the system to move into the negative growth stable state."}
# Set up time vector and parameters
defpars <- def_pars()  # Get default parameters
defpars <- replace(defpars, "initS", 1)  # Start with high S biomass to avoid alternate steady state of negative growth

# Define environments for conducting sensitivity analysis
envs <- list(
  HLHN=list(L=30, N=4e-6, X=0)
)

# Define relative changes in each parameter to evaluate
levs <- seq(0.5, 1.5, 0.05)  # Set levels of % change in parameter value to evaluate

# Define all simulations to be run for a given parameter
sims <- expand.grid(env=names(envs), change=levs)
n <- nrow(sims)

# Set up cluster for parallel processing
cl <- makeCluster(detectCores())  # Initiate cluster
registerDoParallel(cl)

# Run sensitivity analysis in each environment for each parameter
jHT0.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jHT0", change=change))
jNm.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jNm", change=change))
jHGm.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jHGm", change=change))
kCO2.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="kCO2", change=change))
KN.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="KN", change=change))
jST0.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jST0", change=change))
kNPQ.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="kNPQ", change=change))
kROS.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="kROS", change=change))
astar.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="astar", change=change))
jCPm.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jCPm", change=change))
jSGm.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jSGm", change=change))
b.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="b", change=change))

stopCluster(cl)  # Stop cluster

# Combine output with input
sens.all <- ls(pattern="*.sens")
for (i in 1:length(sens.all)) {
  assign(sens.all[i], cbind(sims, get(sens.all[i])))
}

# When growth rate becomes negative, set all responses to NA
for (i in 1:length(sens.all)) {
  if (any(get(sens.all[i])$grchange < 0, na.rm=T)) {
    assign(sens.all[i], within(get(sens.all[i]), {
      shchange <- replace(shchange, grchange < 0, NA)
      cROSchange <- replace(cROSchange, grchange < 0, NA)
      grchange <- replace(grchange, grchange < 0, NA)
    }))
  }
}

# Plot Figure
par(mfrow=c(2,2), mar=c(3,3,1,1), mgp=c(2,0.5,0))
sens.plot(response=c("grchange", "shchange"), pars=c("jCPm", "kCO2", "astar"), cols=c("black", "red", "gold"))
sens.plot(response=c("grchange", "shchange"), pars=c("jNm", "KN"), cols=c("black", "blue"))
sens.plot(response=c("grchange", "shchange"), pars=c("jST0", "jHT0", "jSGm", "jHGm"), cols=c("burlywood4", "burlywood3", "darkolivegreen4", "darkolivegreen3"))
sens.plot(response=c("grchange", "shchange"), pars=c("kNPQ", "kROS", "b"), cols=c("black", "orange", "purple"))
```

-----

# Figure S8
```{r FigS8, cache=T, fig.width=7, fig.height=7, eval=T, fig.cap="**Fig. S8. Full system dynamics of seasonal light variation at two nutrient levels.** This figure accompanies Figure 5 in the main text, and shows additional model fluxes that demonstrate the mechanisms underlying the changes in the system state in these simulations."}
# Set parameters
defpars <- def_pars()  # Get default parameters

# Set run time vector
time <- seq(1, 365, 0.1)  # if single model run, use time input

# Initialize environments
env1 <- init_env(time=time, L=c(20,44,2), N=c(0.14e-6,0.14e-6,0), X=c(1e-6,1e-6,0))
env2 <- init_env(time=time, L=c(20,44,2), N=c(15.14e-6,15.14e-6,0), X=c(1e-6,1e-6,0))

# Run simulations
ss1 <- with(coRal::run_coral_ss(env=list(L=32,N=0.14e-6,X=1e-6), pars=defpars, dt=0.1), dplyr::last(S$S/H$H))
run1 <- coRal::run_coral(time=time, env=env1, pars=replace(defpars, "initS", ss1))
ss2 <- with(coRal::run_coral_ss(env=list(L=32,N=15.14e-6,X=1e-6), pars=defpars, dt=0.1), dplyr::last(S$S/H$H))
run2 <- coRal::run_coral(time=time, env=env2, pars=replace(defpars, "initS", ss2))

par(mfcol=c(6,2), mar=c(2,2,1,4), mgp=c(1,0,0), tcl=0.2, xaxs="i")

with(run1, {
      # External irradiance
    plot(time, env$L, type="l", col="gold", ylim=c(0,60), lwd=2, xlab="", ylab="mol ph/m2/d")
    title("External irradiance and DIN", adj=0, line=0.25)
    par(new=T)
    plot(time, env$N, type="l", col="blue", ylim=c(0,10.14e-6), lwd=2, axes=F, xlab="", ylab="")
    axis(side=4); mtext(side=4, text="molN/L", line=1, cex=0.75)
    
    # Symbiont to host biomass ratio
    totSH <- S$S / H$H
    totSHf <- totSH[length(totSH)]
    plot(time, totSH, type="l", col="black", ylim=c(0, 0.25), ylab="CmolS/CmolH", xlab="", lwd=2)
    text(time[0.95*length(time)], totSHf, labels=as.character(round(totSHf, 3)), pos=3, xpd=T, cex=0.75)
    title("Symbiont:host biomass", adj=0, line=0.25)
    
    # Specific growth rates of host and symbiont
    Hgrf <- H$dH.Hdt[length(H$dH.Hdt)]
    plot(time, H$dH.Hdt, type="l", ylim=c(-0.01, 0.13), 
         xlab="", ylab="d-1", lwd=2, cex=1, cex.lab=1)
    if(any(c(H$dH.Hdt[-(1:10)], S$dS.Sdt[-(1:10)])<0)) abline(h=0, lwd=0.5, lty=3)
    text(time[0.95*length(time)], Hgrf, labels=as.character(round(Hgrf, 3)), pos=3, xpd=T, cex=0.75)
    #title("State variable dynamics", adj=0, cex.main=2, outer = T)
    title("Specific growth rates", adj=0, line=0.25)
    lines(time, S$dS.Sdt, col="black", lwd=1)
    legend("topright", legend=c("Host", "Sym"), lwd=c(2,1), col="black", bty="n", y.intersp=1, cex=0.75)
    
    # Light quenching (carbon fixation, NPQ, and excess (=ROS producing))
    plot(NA, xlim=range(time), xlab="", ylim=c(0,130), ylab="mol ph/CmolS/d")
    title("Light quenching", adj=0, line=0.25)
    lines(time, S$jCP/pars$yCL, col="gold", lwd=1) # amt. quenched by photosynthesis
    lines(time, S$jCP/pars$yCL + S$jNPQ, col="gold", lty=1, lwd=2) # amt. quenched by photo + NPQ
    lines(time, S$jL, col="gold", lty=3, lwd=2) # total amt. absorbed
    legend("topright", legend=c("ROS", "NPQ", "Photo."), lty=c(3,1,1), lwd=c(2,2,1), col="gold", bty="n", cex=0.75)

    # Photosynthesis: substrate-limitation
    pl <- log(   pmin((H$jCO2 + H$rCH)*H$H/S$S + S$rCS, pars$jCPm)   /   pmin(S$jL * pars$yCL, pars$jCPm)    )
    plot(NA, xlim=range(time), xlab="", ylab="", ylim=c(-2, 2))
    title("Photosynthesis: substrate-limitation", adj=0, line=0.25)
    lines(time, pl, col="black", lty=1, lwd=2)
    abline(h=0, lty=3)
    text(par("usr")[2], 0, labels="L-lim.\nCO2-lim.", cex=0.75, adj=1)
    
    # Biomass formation - substrate-limitation
    sl <- log(  pmin(pars$yC*S$jCP, pars$jSGm)   /   pmin((H$rhoN*H$H/S$S + S$rNS)/pars$nNS, pars$jSGm)  )
    hl <- log(  pmin(pars$yC*S$rhoC*S$S/H$H + H$jX, pars$jHGm) / pmin((H$jN + pars$nNX*H$jX + H$rNH) / pars$nNH, pars$jHGm)  )
    maxabs <- max(c(abs(hl), abs(sl)))
    range <- range(c(hl, sl))
    plot(NA, xlim=range(time), xlab="", ylab="", ylim=c(-1.5,1.5))
    title("Biomass: substrate-limitation", adj=0, line=0.25)
    lines(time, hl, col="black", lty=1, lwd=2)
    lines(time, sl, col="black", lty=1, lwd=1)
    abline(h=0, lty=3)
    text(par("usr")[2], 0, labels="N-lim.\nC-lim.", cex=0.75, adj=1)
    legend("topright", legend=c("Host", "Sym"), lty=1, lwd=c(2,1), col="black", bty="n", cex=0.75)
})

with(run2, {
      # External irradiance
    plot(time, env$L, type="l", col="gold", ylim=c(0,60), lwd=2, xlab="", ylab="mol/m2/d")
    title("External irradiance and DIN", adj=0, line=0.25)
    par(new=T)
    plot(time, env$N, type="l", col="blue", ylim=c(0,10.14e-6), lwd=2, axes=F, xlab="", ylab="")
    axis(side=4); mtext(side=4, text="molN/L", line=1, cex=0.75)
    
    # Symbiont to host biomass ratio
    totSH <- S$S / H$H
    totSHf <- totSH[length(totSH)]
    plot(time, totSH, type="l", col="black", ylim=c(0, 0.25), ylab="CmolS/CmolH", xlab="", lwd=2)
    text(time[0.95*length(time)], totSHf, labels=as.character(round(totSHf, 3)), pos=3, xpd=T, cex=0.75)
    title("Symbiont:host biomass", adj=0, line=0.25)
    
    # Specific growth rates of host and symbiont
    Hgrf <- H$dH.Hdt[length(H$dH.Hdt)]
    plot(time, H$dH.Hdt, type="l", ylim=c(-0.01,0.13), 
         xlab="", ylab="d-1", lwd=2, cex=1, cex.lab=1)
    if(any(c(H$dH.Hdt[-(1:10)], S$dS.Sdt[-(1:10)])<0)) abline(h=0, lwd=0.5, lty=3)
    text(time[0.95*length(time)], Hgrf, labels=as.character(round(Hgrf, 3)), pos=3, xpd=T, cex=0.75)
    #title("State variable dynamics", adj=0, cex.main=2, outer = T)
    title("Specific growth rates", adj=0, line=0.25)
    lines(time, S$dS.Sdt, col="black", lwd=1)
    legend("topright", legend=c("Host", "Sym"), lwd=c(2,1), col="black", bty="n", y.intersp=1, cex=0.75)
    
    # Light quenching (carbon fixation, NPQ, and excess (=ROS producing))
    plot(NA, xlim=range(time), xlab="", ylim=c(0,130), ylab="mol ph/CmolS/d")
    title("Light quenching", adj=0, line=0.25)
    lines(time, S$jCP/pars$yCL, col="gold", lwd=1) # amt. quenched by photosynthesis
    lines(time, S$jCP/pars$yCL + S$jNPQ, col="gold", lty=1, lwd=2) # amt. quenched by photo + NPQ
    lines(time, S$jL, col="gold", lty=3, lwd=2) # total amt. absorbed
    legend("topright", legend=c("ROS", "NPQ", "Photo."), lty=c(3,1,1), lwd=c(2,2,1), col="gold", bty="n", cex=0.75)

    # Photosynthesis: substrate-limitation
    pl <- log(   pmin((H$jCO2 + H$rCH)*H$H/S$S + S$rCS, pars$jCPm)   /   pmin(S$jL * pars$yCL, pars$jCPm)    )
    maxabs <- max(abs(pl))
    plot(NA, xlim=range(time), xlab="", ylab="", ylim=c(-2, 2))
    title("Photosynthesis: substrate-limitation", adj=0, line=0.25)
    lines(time, pl, col="black", lty=1, lwd=2)
    abline(h=0, lty=3)
    text(par("usr")[2], 0, labels="L-lim.\nCO2-lim.", cex=0.75, adj=1)
    
    # Biomass formation - substrate-limitation
    sl <- log(  pmin(pars$yC*S$jCP, pars$jSGm)   /   pmin((H$rhoN*H$H/S$S + S$rNS)/pars$nNS, pars$jSGm)  )
    hl <- log(  pmin(pars$yC*S$rhoC*S$S/H$H + H$jX, pars$jHGm) / pmin((H$jN + pars$nNX*H$jX + H$rNH) / pars$nNH, pars$jHGm)  )
    maxabs <- max(c(abs(hl), abs(sl)))
    range <- range(c(hl, sl))
    plot(NA, xlim=range(time), xlab="", ylab="", ylim=c(-1.5,1.5))
    title("Biomass: substrate-limitation", adj=0, line=0.25)
    lines(time, hl, col="black", lty=1, lwd=2)
    lines(time, sl, col="black", lty=1, lwd=1)
    abline(h=0, lty=3)
    text(par("usr")[2], 0, labels="N-lim.\nC-lim.", cex=0.75, adj=1)
    legend("topright", legend=c("Host", "Sym"), lty=1, lwd=c(2,1), col="black", bty="n", cex=0.75)
})
```

-----

# References