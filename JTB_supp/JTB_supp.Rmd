---
title: "A simplified dynamic bioenergetic model for coral-algal symbiosis and coral bleaching"
author: "Ross Cunning, Erik B. Muller, Ruth D. Gates, Roger M. Nisbet"
output: html_document
bibliography: library.bib
---

# Supplementary Information
This supplement provides justification and derivations from the literature for all parameter values used in the model, as well as additional figures that demonstrate the structure and behavior of the model and its specific components.

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = normalizePath(".."))
knitr::opts_chunk$set(message = F, warning = F)
```

```{r initialize, include=FALSE}
# Source default parameters and functions
sapply(c("R/conversions.R", "R/def_pars.R", "R/init_env.R", "R/plot_results.R",
         "R/run_coral.R", "R/run_coral_ss.R", "R/sym_PI.R", "R/run_steady_states.R", 
         "R/plot_steady_states.R", "R/sensitivity.R"), source, .GlobalEnv)
# Get default parameters
defpars <- def_pars()
```

## Parameter value derivations
All parameters in the model are listed here along with the relevant literature that provides a basis for the value used. In most cases, the units of the values reported in the literature needed to be converted to units appropriate for the model, which was accomplished using a consistent set of stoichiometric conversion factors also based on reported literature (see "R/conversions.R" in this paper's data repository). The specific calculations used to convert values from the units reported in the literature to the relevant units for the model can be found in the RMarkdown code used to produce this document.

* $n_{NH}$: N:C molar ratio in host biomass
    + @Horwitz:2015cf measured a C:N ratio of 5.53 in anemones under control conditions, which converts to:
    + Value used: `r defpars$nNH` (N:C ratio, dimensionless)
* $n_{NS}$: N:C molar ratio in symbiont biomass
    + This value should approximate the Redfield ratio (following @Muller:2009io).
    + Value used: `r defpars$nNS` (dimensionless)
* $n_{NX}$: N:C molar ratio in prey biomass
    + Assuming the coral feeds primarily on zooplankton, a general heterotroph has a N:C ratio of 0.2 [@Muller:2009io].
    + Value used: `r defpars$nNX` (N:C ratio, dimensionless)
* $j_{HT}^0$: Specific turnover rate of host biomass
    + @Jacobson:2016bk parameterized a DEB model for coral symbiosis, and reported a specific maintenance rate (analagous to the turnover rate in the current model) of 0.03 CmolH CmolH^-1^ d^-1^.
    + Value used: `r defpars$jHT0` CmolH CmolH^-1^ d^-1^
* $j_{ST}^0$: Specific turnover rate of symbiont biomass
    + Assuming an equivalent maintenance rate as the host:
    + Value used: `r defpars$jST0` CmolS CmolS^-1^ d^-1^
* $\sigma_{NH}, \sigma_{CH}, \sigma_{NS}, \sigma_{CS}$: Proportions of nitrogen and carbon recycled from host and symbiont biomass turnover
    + Assuming highly efficient recycling to avoid loss to the environment:
    + Values used: `r with(defpars, c(sigmaNH, sigmaCH, sigmaNS, sigmaCS))` (dimensionless)
* $j_{Xm}$: Maximum specific feeding rate of host
    + @Wijgerde:2011du measured depletion of carbon from captured prey in *Galaxea fascicularis* (including both intracoelenteric and extracoelenteric feeding), reporting a maximum specific feeding rate of 77.6 µgC cm^-2^ 6h^-1^. This converts to:
    + Value used: `r round(77.6 / µg.g / gC.molC * cm2.m2 / CmolR.m2_Gfas * 4, 2)` molX CmolH^-1^ d^-1^
* $K_X$: Half-saturation constant for prey uptake by host
    + @Purser:2010hp measured feeding rates of the coral *Lophelia pertusa* at different concentrations of *Artemia* nauplii, reporting a half-saturation for feeding of ~345 *Artemia* L^-1^. This converts to:
    + Value used: $`r round(345 * gC.artemia / gC.molC, 7)`$ CmolX L^-1^
* $j_{Nm}$: Maximum specific DIN uptake rate by host
    + @Muscatine:1978fa measured ammonium uptake in 3 coral species and reported an average value of 7.22 µmol NH~4~^+^-N mg chl *a*^-1^ h^-1^ (Table 1, uncorrected), which converts to `r 7.22 * h.d * nmolchlA.cm2 * gchlA.molchlA * mg.g / nmol.mol / CmolR.m2_Spis * cm2.m2 / µmol.mol` mol NH~4~^+^-N  CmolH^-1^ d^-1^.
    + @HoeghGuldberg:1999p3974 measured ammonium and dissolved free amino acid uptake in *Pocillopora damicornis* and reported a maximum rate of 91.8 nmol N cm^-2^ h^-1^, which converts to `r 91.8 * h.d * cm2.m2 / CmolR.m2_Spis / nmol.mol` molN CmolH^-1^ d^-1^.
    + @Godinot:2011jg measured nitrate and ammonium uptake rates in *Stylophora pistillata* under high nutrient concentrations and reported a maximum value of 3.5 µmolN mg chl^-1^ d^-1^ [addition of bars in Fig. 4D,E @ 29°C], which converts to `r 3.5 * h.d * 22 / CmolR.m2_Spis * cm2.m2 / µmol.mol / 1000` molN CmolH^-1^ d^-1^.
    + @Godinot:2011bm measured ammonium uptake kinetics in *Stylophora pistillata* and reported a maximum rate of 5.42 molN mg chl^-1^ h^-1^, which converts to `r 5.42 * h.d * µgchl.cm2_Spis / CmolR.m2_Spis * cm2.m2 / µmol.mol / 1000` molN CmolH^-1^ d^-1^.
    + Averaging these reported values, we arrive at:
    + Value used: `r round(mean(c(7.22 * h.d * nmolchlA.cm2 * gchlA.molchlA * mg.g / nmol.mol / CmolR.m2_Spis * cm2.m2 / µmol.mol, 91.8 * h.d * cm2.m2 / CmolR.m2_Spis / nmol.mol, 3.5 * h.d * 22 / CmolR.m2_Spis * cm2.m2 / µmol.mol / 1000, 5.42 * h.d * µgchl.cm2_Spis / CmolR.m2_Spis * cm2.m2 / µmol.mol / 1000)), 3)` molN CmolH^-1^ d^-1^.
* $K_N$: Half-saturation constant for DIN uptake by host
    + @Muscatine:1978fa measured ammonium uptake in 3 coral species and reported an average half-saturation constant of 1.84 µmolN L^-1^ (Table 1, uncorrected).
    + @Godinot:2011bm measured ammoinum uptake kinetics in *Stylophora pistillata* and reported a half-saturation constant of 0.46 µmol N L^-1^.
    + Averaging these reported values (weighted by number of species measured), we arrive at:
    + Value used: `r round((1.84*3 + 0.46*1)/4, 2)` molN L^-1^
* $k_{CO_2}$: Efficacy of CO~2~ delivery by host CCMs
    + This parameter represents the relative amount of CO~2~ that can be delivered by the host to photosynthesis given the reducing power generated from 1 mol of fixed carbon. We assume that the host uses a portion of its fixed carbon to generate ATP which is then used to activate a variety of carbon concentrating mechanisms (see @Wooldridge:2013tj). We assume these CCMs are efficient and can deliver an order of magnitude more CO~2~ relative to the fixed carbon available.
    + Value used: 10 molCO~2~ molC^-1^
* $j_{HGm}$: Maximum specific growth rate of host 
    + Value used: 1 CmolH CmolH^-1^ d^-1^
    + Reference:
* $y_{CL}$: Quantum yield of photosynthesis
    + The maximum theoretical quantum yield is 0.125 mol C fixed per mol photons. @Brodersen:2014gw presented a balanced light budget based on microenvironmental photobiology of *Montastrea curta*, and reported a quantum yield of 0.102 O~2~ photon^-1^.
    + Value used: 0.1 molC molph^-1^
* $\bar{a}^*$: Effective light-absorbing cross-section of symbiont
    + @Hennige:2009p3439 measured spectra-weighted absoprtion coefficients from 400 to 700nm *ā\**~(400-700)~ for eight *Symbiodinium* types in culture at two different light levels, and reported a (grand mean) value of 0.01095 m^2^ mg chl *a*^-1^ [from Table 6]. This converts to:
    + Value used: `r round(0.01095 * mg.g * gchlA.gC * gC.molC, 2)` m^2^ CmolS^-1^
* $k_{NPQ}$: Capacity of non-photochemical quenching
    + @Gorbunov:2001p4181 report that the capacity of non-photochemical quenching is approximately 4 times the capacity of photochemistry on a sunny day. Therefore, we take the maximum relative capacity of NPQ to be 4 times the maximum rate of photochemical quenching ($j_{CPm}$; see below), giving a value of:
    + Value used: `r defpars$jCPm / defpars$yCL * 4` mol ph CmolS^-1^ d^-1^
* $k_{ROS}$: Amount of excitation energy not quenched by photoehcemistry or NPQ that doubles relative production of ROS
    + @McGinty:2012ck report a ~4-fold increase in ROS production in *Symbiodinium* C1 under stressful conditions relative to control. We chose a value of $k_{ROS}$ that similarly produced a ~4-fold increase in ROS production at the highest light level (see Figure S2):
    + Value used: 60 mol ph CmolS^-1^ d^-1^
* $j_{CPm}$: Maximum specific photosynthesis rate of symbiont (molC CmolS^-1^ d^-1^)
    + In theory, this value should be the maximum carboxylation rate of *Symbiodinium* Rubisco (RuBP). @Leggat:2004vx report a maximum carboxylation rate at 29°C of 140 CO~2~ RuBP^-1^ s^-1^ [Max. value, p. 143], which converts to:
    + Value used: `r round(140 * s.h * h.d * RuBP.CmolS, 1)`
* $j_{SGm}$: Maximum specific growth rate of symbiont (CmolS CmolS^-1^ d^-1^)
    + Sugget et al. measured specific growth rates of 5 clades of *Symbiodinium* in culture, and reported values ranging from 0.19 to 0.26 d^-1^ (Table 2). 
    + Value used: 0.25 d^-1^
* $b$: Scaling parameter for strength of bleaching response (dimensionless)
    + This value determines the magnitude of symbiont biomass loss (considered as expulsion of symbionts during bleaching) in response to ROS. In this context, relative ROS concentrations are assumed to trigger symbiont expulsion via unknown signaling mechanisms. Larger values of this parameter cause greater biomass loss in response to ROS signaling (i.e., a more severe bleaching response). Since this represents symbiont cells being expelled from the system, we use a value about an order of magnitude higher than the turnover rate due to maintenance.
    + Value used: 5

## Figure S1. Light amplification and self-shading
```{r lightamp, fig.width=5, fig.height=5, eval=T, include=T, echo=F, fig.cap="The amplification factor (A) is the ratio of internal scalar irradiance experienced by *Symbiodinium* to the external downwelling irradiance, and is greater than 1 due to multiple scattering of incident light by the coral skeleton. The amplification factor decreases as a function of symbiont abundance (converted to symbiont to host biomass ratio) due to self-shading. Data are from Marcelino et al. (2013) using skeletons from three different coral species: pdam=*Pocillopora damicornis*; plob=*Porites lobata*; shys=*Seriatopora hystrix*."}

# Import data from Marcelino et al. 2013
md <- read.csv("data/marcelino2013_fig2a.csv")
md$S.H <- md$density * cm2.m2 / CmolR.m2 * CmolS.cellS  # Convert units of symbiont density to CmolS/CmolR
md$A <- md$E + 1  # Convert "E"=excess light metric of Marcelino to "A"=amplification factor
# Plot data
par(mfrow=c(1,1), mar=c(3,3,3,3), mgp=c(1.2,0,0), cex=1, tck=0.025)
plot(md$A ~ md$S.H, pch=c(21,23,22)[factor(md$spp)], bg=c("white", "black", "gray")[factor(md$spp)], 
     ylab="A (Amplification factor)", ylim=c(1,3.2),
     xlab="S:H biomass")
legend("topright", legend=levels(md$spp), pch=c(21,23,22), pt.bg=c("white", "black", "gray"), inset=0.02)
# Fit exponential decay model and plot fitted values
mod <- nls(A ~ x + y * exp(z * S.H), data=md, start=list(x=1, y=2, z=-3))
fit <- predict(mod, list(S.H=seq(0, 0.5, 0.01)))
lines(fit ~ seq(0, 0.5, 0.01))
# Get parameters of fit and add to plot
text(0.13,3.1, labels=paste0(c("A = ", as.character(formula(mod))[3]), collapse=""), adj=0)
coefs <- round(coef(mod), 2)
text(0.13,2.9, labels=paste0(c("x=",coefs[1],"; y=",coefs[2],"; z=",coefs[3]), collapse=""), adj=0)
```

## Figure S2. Photosynthesis-Irradiance curves of modeled symbiont.
```{r run1_PI, cache=F, fig.height=4, fig.width=7, echo=F, fig.cap="The amount of light energy quenched through photochemistry (red line) and non-photochemical quenching (black line), and the relative production of reactive oxygen species (orange line) are plotted as a function of the scalar irradiance experienced by the symbiont (note different y-axes for each line). These simulations represent the behavior of the photosynthesis SU independent of the host and without CO~2~ limitation of photosynthesis (*j~CO2~* set to a very high value). The structure of the photosynthesis SU, with the negative feedback between excess light and photosynthesis rate, produces the classic shape of a P-I curve demonstrating photoinhibition, suggesting the mechanism is robust."}
sym_PI(pars=def_pars())
```

## Figure S3. Sensitivity analysis under high DIN (4e-6 M) and intermediate light (15 mol m^-2^ d^-1^).
```{r sens_ILHN, cache=T, echo=F}
# Set up time vector and parameters
defpars <- def_pars()  # Get default parameters
defpars <- replace(defpars, "initS", 1)  # Start with high S biomass to avoid alternate steady state of negative growth

# Define environments for conducting sensitivity analysis
envs <- list(
  ILHN=list(L=15, N=4e-6, X=0)
)

# Define relative changes in each parameter to evaluate
levs <- seq(0.5, 1.5, 0.05)  # Set levels of % change in parameter value to evaluate

# Define all simulations to be run for a given parameter
sims <- expand.grid(env=names(envs), change=levs)
n <- nrow(sims)

# Set up cluster for parallel processing
cl <- makeCluster(detectCores())  # Initiate cluster
registerDoParallel(cl)

# Run sensitivity analysis in each environment for each parameter
jHT0.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jHT0", change=change))
jNm.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jNm", change=change))
jHGm.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jHGm", change=change))
kCO2.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="kCO2", change=change))
KN.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="KN", change=change))
jST0.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jST0", change=change))
kNPQ.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="kNPQ", change=change))
kROS.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="kROS", change=change))
astar.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="astar", change=change))
jCPm.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jCPm", change=change))
jSGm.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jSGm", change=change))
b.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="b", change=change))

stopCluster(cl)  # Stop cluster

# Combine output with input
sens.all <- ls(pattern="*.sens")
for (i in 1:length(sens.all)) {
  assign(sens.all[i], cbind(sims, get(sens.all[i])))
}

# When growth rate becomes negative, set all responses to NA
for (i in 1:length(sens.all)) {
  if (any(get(sens.all[i])$grchange < 0, na.rm=T)) {
    assign(sens.all[i], within(get(sens.all[i]), {
      shchange <- replace(shchange, grchange < 0, NA)
      cROSchange <- replace(cROSchange, grchange < 0, NA)
      grchange <- replace(grchange, grchange < 0, NA)
    }))
  }
}

# Plot Figure
par(mfrow=c(2,2), mar=c(3,3,1,1), mgp=c(2,0.5,0))
sens.plot(response=c("grchange", "shchange"), pars=c("jCPm", "kCO2", "astar"), cols=c("black", "red", "gold"))
sens.plot(response=c("grchange", "shchange"), pars=c("jNm", "KN"), cols=c("black", "blue"))
sens.plot(response=c("grchange", "shchange"), pars=c("jST0", "jHT0", "jSGm", "jHGm"), cols=c("burlywood4", "burlywood3", "darkolivegreen4", "darkolivegreen3"))
sens.plot(response=c("grchange", "shchange"), pars=c("kNPQ", "kROS", "b"), cols=c("black", "orange", "purple"))
```

## Figure S4. Sensitivity analysis under low DIN (1e-7 M) and low light (2 mol m^-2^ d^-1^).
```{r sens_LLLN, cache=T, echo=F}
# Set up time vector and parameters
defpars <- def_pars()  # Get default parameters
defpars <- replace(defpars, "initS", 1)  # Start with high S biomass to avoid alternate steady state of negative growth

# Define environments for conducting sensitivity analysis
envs <- list(
  LLLN=list(L=2, N=1e-7, X=0)
)

# Define relative changes in each parameter to evaluate
levs <- seq(0.5, 1.5, 0.05)  # Set levels of % change in parameter value to evaluate

# Define all simulations to be run for a given parameter
sims <- expand.grid(env=names(envs), change=levs)
n <- nrow(sims)

# Set up cluster for parallel processing
cl <- makeCluster(detectCores())  # Initiate cluster
registerDoParallel(cl)

# Run sensitivity analysis in each environment for each parameter
jHT0.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jHT0", change=change))
jNm.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jNm", change=change))
jHGm.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jHGm", change=change))
kCO2.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="kCO2", change=change))
KN.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="KN", change=change))
jST0.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jST0", change=change))
kNPQ.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="kNPQ", change=change))
kROS.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="kROS", change=change))
astar.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="astar", change=change))
jCPm.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jCPm", change=change))
jSGm.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jSGm", change=change))
b.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="b", change=change))

stopCluster(cl)  # Stop cluster

# Combine output with input
sens.all <- ls(pattern="*.sens")
for (i in 1:length(sens.all)) {
  assign(sens.all[i], cbind(sims, get(sens.all[i])))
}

# When growth rate becomes negative, set all responses to NA
for (i in 1:length(sens.all)) {
  if (any(get(sens.all[i])$grchange < 0, na.rm=T)) {
    assign(sens.all[i], within(get(sens.all[i]), {
      shchange <- replace(shchange, grchange < 0, NA)
      cROSchange <- replace(cROSchange, grchange < 0, NA)
      grchange <- replace(grchange, grchange < 0, NA)
    }))
  }
}

# Plot Figure
par(mfrow=c(2,2), mar=c(3,3,1,1), mgp=c(2,0.5,0))
sens.plot(response=c("grchange", "shchange"), pars=c("jCPm", "kCO2", "astar"), cols=c("black", "red", "gold"))
sens.plot(response=c("grchange", "shchange"), pars=c("jNm", "KN"), cols=c("black", "blue"))
sens.plot(response=c("grchange", "shchange"), pars=c("jST0", "jHT0", "jSGm", "jHGm"), cols=c("burlywood4", "burlywood3", "darkolivegreen4", "darkolivegreen3"))
sens.plot(response=c("grchange", "shchange"), pars=c("kNPQ", "kROS", "b"), cols=c("black", "orange", "purple"))
```

## Figure S5. Sensitivity analysis under high DIN (4e-6 M) and low light (2 mol m^-2^ d^-1^).
```{r sens_LLHN, cache=T, echo=F}
# Set up time vector and parameters
defpars <- def_pars()  # Get default parameters
defpars <- replace(defpars, "initS", 1)  # Start with high S biomass to avoid alternate steady state of negative growth

# Define environments for conducting sensitivity analysis
envs <- list(
  LLHN=list(L=2, N=4e-6, X=0)
)

# Define relative changes in each parameter to evaluate
levs <- seq(0.5, 1.5, 0.05)  # Set levels of % change in parameter value to evaluate

# Define all simulations to be run for a given parameter
sims <- expand.grid(env=names(envs), change=levs)
n <- nrow(sims)

# Set up cluster for parallel processing
cl <- makeCluster(detectCores())  # Initiate cluster
registerDoParallel(cl)

# Run sensitivity analysis in each environment for each parameter
jHT0.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jHT0", change=change))
jNm.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jNm", change=change))
jHGm.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jHGm", change=change))
kCO2.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="kCO2", change=change))
KN.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="KN", change=change))
jST0.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jST0", change=change))
kNPQ.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="kNPQ", change=change))
kROS.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="kROS", change=change))
astar.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="astar", change=change))
jCPm.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jCPm", change=change))
jSGm.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jSGm", change=change))
b.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="b", change=change))

stopCluster(cl)  # Stop cluster

# Combine output with input
sens.all <- ls(pattern="*.sens")
for (i in 1:length(sens.all)) {
  assign(sens.all[i], cbind(sims, get(sens.all[i])))
}

# When growth rate becomes negative, set all responses to NA
for (i in 1:length(sens.all)) {
  if (any(get(sens.all[i])$grchange < 0, na.rm=T)) {
    assign(sens.all[i], within(get(sens.all[i]), {
      shchange <- replace(shchange, grchange < 0, NA)
      cROSchange <- replace(cROSchange, grchange < 0, NA)
      grchange <- replace(grchange, grchange < 0, NA)
    }))
  }
}

# Plot Figure
par(mfrow=c(2,2), mar=c(3,3,1,1), mgp=c(2,0.5,0))
sens.plot(response=c("grchange", "shchange"), pars=c("jCPm", "kCO2", "astar"), cols=c("black", "red", "gold"))
sens.plot(response=c("grchange", "shchange"), pars=c("jNm", "KN"), cols=c("black", "blue"))
sens.plot(response=c("grchange", "shchange"), pars=c("jST0", "jHT0", "jSGm", "jHGm"), cols=c("burlywood4", "burlywood3", "darkolivegreen4", "darkolivegreen3"))
sens.plot(response=c("grchange", "shchange"), pars=c("kNPQ", "kROS", "b"), cols=c("black", "orange", "purple"))
```

## Figure S6. Sensitivity analysis under low DIN (1e-7 M) and high light (25 mol m^-2^ d^-1^).
```{r sens_HLLN, cache=T, echo=F}
# Set up time vector and parameters
defpars <- def_pars()  # Get default parameters
defpars <- replace(defpars, "initS", 1)  # Start with high S biomass to avoid alternate steady state of negative growth

# Define environments for conducting sensitivity analysis
envs <- list(
  HLLN=list(L=25, N=1e-7, X=0)
)

# Define relative changes in each parameter to evaluate
levs <- seq(0.5, 1.5, 0.05)  # Set levels of % change in parameter value to evaluate

# Define all simulations to be run for a given parameter
sims <- expand.grid(env=names(envs), change=levs)
n <- nrow(sims)

# Set up cluster for parallel processing
cl <- makeCluster(detectCores())  # Initiate cluster
registerDoParallel(cl)

# Run sensitivity analysis in each environment for each parameter
jHT0.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jHT0", change=change))
jNm.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jNm", change=change))
jHGm.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jHGm", change=change))
kCO2.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="kCO2", change=change))
KN.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="KN", change=change))
jST0.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jST0", change=change))
kNPQ.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="kNPQ", change=change))
kROS.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="kROS", change=change))
astar.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="astar", change=change))
jCPm.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jCPm", change=change))
jSGm.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jSGm", change=change))
b.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="b", change=change))

stopCluster(cl)  # Stop cluster

# Combine output with input
sens.all <- ls(pattern="*.sens")
for (i in 1:length(sens.all)) {
  assign(sens.all[i], cbind(sims, get(sens.all[i])))
}

# When growth rate becomes negative, set all responses to NA
for (i in 1:length(sens.all)) {
  if (any(get(sens.all[i])$grchange < 0, na.rm=T)) {
    assign(sens.all[i], within(get(sens.all[i]), {
      shchange <- replace(shchange, grchange < 0, NA)
      cROSchange <- replace(cROSchange, grchange < 0, NA)
      grchange <- replace(grchange, grchange < 0, NA)
    }))
  }
}

# Plot Figure
par(mfrow=c(2,2), mar=c(3,3,1,1), mgp=c(2,0.5,0))
sens.plot(response=c("grchange", "shchange"), pars=c("jCPm", "kCO2", "astar"), cols=c("black", "red", "gold"))
sens.plot(response=c("grchange", "shchange"), pars=c("jNm", "KN"), cols=c("black", "blue"))
sens.plot(response=c("grchange", "shchange"), pars=c("jST0", "jHT0", "jSGm", "jHGm"), cols=c("burlywood4", "burlywood3", "darkolivegreen4", "darkolivegreen3"))
sens.plot(response=c("grchange", "shchange"), pars=c("kNPQ", "kROS", "b"), cols=c("black", "orange", "purple"))
```

## Figure S7. Sensitivity analysis under high DIN (4e-6 M) and high light (25 mol m^-2^ d^-1^).
```{r sens_HLHN, cache=T, echo=F}
# Set up time vector and parameters
defpars <- def_pars()  # Get default parameters
defpars <- replace(defpars, "initS", 1)  # Start with high S biomass to avoid alternate steady state of negative growth

# Define environments for conducting sensitivity analysis
envs <- list(
  HLHN=list(L=25, N=4e-6, X=0)
)

# Define relative changes in each parameter to evaluate
levs <- seq(0.5, 1.5, 0.05)  # Set levels of % change in parameter value to evaluate

# Define all simulations to be run for a given parameter
sims <- expand.grid(env=names(envs), change=levs)
n <- nrow(sims)

# Set up cluster for parallel processing
cl <- makeCluster(detectCores())  # Initiate cluster
registerDoParallel(cl)

# Run sensitivity analysis in each environment for each parameter
jHT0.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jHT0", change=change))
jNm.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jNm", change=change))
jHGm.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jHGm", change=change))
kCO2.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="kCO2", change=change))
KN.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="KN", change=change))
jST0.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jST0", change=change))
kNPQ.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="kNPQ", change=change))
kROS.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="kROS", change=change))
astar.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="astar", change=change))
jCPm.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jCPm", change=change))
jSGm.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="jSGm", change=change))
b.sens <- foreach(i=1:n, .combine=rbind) %dopar% with(sims[i,], sens(env=envs[[env]], pars=defpars, par="b", change=change))

stopCluster(cl)  # Stop cluster

# Combine output with input
sens.all <- ls(pattern="*.sens")
for (i in 1:length(sens.all)) {
  assign(sens.all[i], cbind(sims, get(sens.all[i])))
}

# When growth rate becomes negative, set all responses to NA
for (i in 1:length(sens.all)) {
  if (any(get(sens.all[i])$grchange < 0, na.rm=T)) {
    assign(sens.all[i], within(get(sens.all[i]), {
      shchange <- replace(shchange, grchange < 0, NA)
      cROSchange <- replace(cROSchange, grchange < 0, NA)
      grchange <- replace(grchange, grchange < 0, NA)
    }))
  }
}

# Plot Figure
par(mfrow=c(2,2), mar=c(3,3,1,1), mgp=c(2,0.5,0))
sens.plot(response=c("grchange", "shchange"), pars=c("jCPm", "kCO2", "astar"), cols=c("black", "red", "gold"))
sens.plot(response=c("grchange", "shchange"), pars=c("jNm", "KN"), cols=c("black", "blue"))
sens.plot(response=c("grchange", "shchange"), pars=c("jST0", "jHT0", "jSGm", "jHGm"), cols=c("burlywood4", "burlywood3", "darkolivegreen4", "darkolivegreen3"))
sens.plot(response=c("grchange", "shchange"), pars=c("kNPQ", "kROS", "b"), cols=c("black", "orange", "purple"))
```

## Figure S8. Full system dynamics of seasonal light variation at two nutrient levels.
This figure accompanies Figure 4 in the main text, and show additional model fluxes that demonstrate the mechanisms underlying the changes in the system state in these simulations.

```{r FigS8, cache=T, fig.width=7, fig.height=7}
# Set parameters
defpars <- def_pars()  # Get default parameters

# Set run time vector
time <- seq(1, 365, 0.5)  # if single model run, use time input

# Initialize environments
env1 <- init_env(time=time, L=c(20,40,2), N=c(1e-7,1e-7,0), X=c(1e-5,1e-5,0))
env2 <- init_env(time=time, L=c(20,40,2), N=c(1e-6,1e-6,0), X=c(1e-5,1e-5,0))

# Run simulations
ss1 <- with(run_coral_ss(env=list(L=30,N=1e-7,X=1e-5), pars=defpars), last(S$S/H$H))
run1 <- run_coral(time=time, env=env1, pars=replace(defpars, "initS", ss1))
ss2 <- with(run_coral_ss(env=list(L=30,N=1e-6,X=1e-5), pars=defpars), last(S$S/H$H))
run2 <- run_coral(time=time, env=env2, pars=replace(defpars, "initS", ss2))

par(mfcol=c(6,2), mar=c(2,2,1,4), mgp=c(1,0,0), tcl=0.2)

with(run1, {
      # External irradiance
    plot(time, env$L, type="l", col="gold", ylim=c(0,60), lwd=2, xlab="", ylab="mol ph/m2/d")
    title("External irradiance and DIN", adj=0, line=0.25)
    par(new=T)
    plot(time, env$N, type="l", col="blue", ylim=c(0,1e-5), lwd=2, axes=F, xlab="", ylab="")
    axis(side=4); mtext(side=4, text="molN/L", line=1, cex=0.75)
    
    # Symbiont to host biomass ratio
    totSH <- S$S / H$H
    totSHf <- totSH[length(totSH)]
    plot(time, totSH, type="l", col="black", ylim=c(0, 0.25), ylab="CmolS/CmolH", xlab="", lwd=2)
    text(time[0.95*length(time)], totSHf, labels=as.character(round(totSHf, 3)), pos=3, xpd=T, cex=0.75)
    title("Symbiont:host biomass", adj=0, line=0.25)
    
    # Specific growth rates of host and symbiont
    Hgrf <- H$dH.Hdt[length(H$dH.Hdt)]
    plot(time, H$dH.Hdt, type="l", ylim=c(-0.01, 0.13), 
         xlab="", ylab="d-1", lwd=2, cex=1, cex.lab=1)
    if(any(c(H$dH.Hdt[-(1:10)], S$dS.Sdt[-(1:10)])<0)) abline(h=0, lwd=0.5, lty=3)
    text(time[0.95*length(time)], Hgrf, labels=as.character(round(Hgrf, 3)), pos=3, xpd=T, cex=0.75)
    #title("State variable dynamics", adj=0, cex.main=2, outer = T)
    title("Specific growth rates", adj=0, line=0.25)
    lines(time, S$dS.Sdt, col="black", lwd=1)
    legend("topright", legend=c("Host", "Sym"), lwd=c(2,1), col="black", bty="n", y.intersp=1, cex=0.75)
    
    # Light quenching (carbon fixation, NPQ, and excess (=ROS producing))
    plot(NA, xlim=range(time), xlab="", ylim=c(0,130), ylab="mol ph/CmolS/d")
    title("Light quenching", adj=0, line=0.25)
    lines(time, S$jCP/pars$yCL, col="gold", lwd=1) # amt. quenched by photosynthesis
    lines(time, S$jCP/pars$yCL + S$jNPQ, col="gold", lty=1, lwd=2) # amt. quenched by photo + NPQ
    lines(time, S$jL, col="gold", lty=3, lwd=2) # total amt. absorbed
    legend("topright", legend=c("ROS", "NPQ", "Photo."), lty=c(3,1,1), lwd=c(2,2,1), col="gold", bty="n", cex=0.75)

    # Photosynthesis: substrate-limitation
    pl <- log(   pmin((H$jCO2 + H$rCH)*H$H/S$S + S$rCS, pars$jCPm)   /   pmin(S$jL * pars$yCL, pars$jCPm)    )
    plot(NA, xlim=range(time), xlab="", ylab="", ylim=c(-0.8, 0.8))
    title("Photosynthesis: substrate-limitation", adj=0, line=0.25)
    lines(time, pl, col="black", lty=1, lwd=2)
    abline(h=0, lty=3)
    text(par("usr")[2], 0, labels="L-lim.\nCO2-lim.", cex=0.75, adj=1)
    
    # Biomass formation - substrate-limitation
    sl <- log(  pmin(S$jCP, pars$jSGm)   /   pmin((H$rhoN*H$H/S$S + S$rNS)/pars$nNS, pars$jSGm)  )
    hl <- log(  pmin(S$rhoC*S$S/H$H + H$jX, pars$jHGm) / pmin((H$jN + pars$nNX*H$jX + H$rNH) / pars$nNH, pars$jHGm)  )
    maxabs <- max(c(abs(hl), abs(sl)))
    range <- range(c(hl, sl))
    plot(NA, xlim=range(time), xlab="", ylab="", ylim=c(-1.5,1.5))
    title("Biomass: substrate-limitation", adj=0, line=0.25)
    lines(time, hl, col="black", lty=1, lwd=2)
    lines(time, sl, col="black", lty=1, lwd=1)
    abline(h=0, lty=3)
    text(par("usr")[2], 0, labels="N-lim.\nC-lim.", cex=0.75, adj=1)
    legend("topright", legend=c("Host", "Sym"), lty=1, lwd=c(2,1), col="black", bty="n", cex=0.75)
})

with(run2, {
      # External irradiance
    plot(time, env$L, type="l", col="gold", ylim=c(0,60), lwd=2, xlab="", ylab="mol/m2/d")
    title("External irradiance and DIN", adj=0, line=0.25)
    par(new=T)
    plot(time, env$N, type="l", col="blue", ylim=c(0,1e-5), lwd=2, axes=F, xlab="", ylab="")
    axis(side=4); mtext(side=4, text="molN/L", line=1, cex=0.75)
    
    # Symbiont to host biomass ratio
    totSH <- S$S / H$H
    totSHf <- totSH[length(totSH)]
    plot(time, totSH, type="l", col="black", ylim=c(0, 0.25), ylab="CmolS/CmolH", xlab="", lwd=2)
    text(time[0.95*length(time)], totSHf, labels=as.character(round(totSHf, 3)), pos=3, xpd=T, cex=0.75)
    title("Symbiont:host biomass", adj=0, line=0.25)
    
    # Specific growth rates of host and symbiont
    Hgrf <- H$dH.Hdt[length(H$dH.Hdt)]
    plot(time, H$dH.Hdt, type="l", ylim=c(-0.01,0.13), 
         xlab="", ylab="d-1", lwd=2, cex=1, cex.lab=1)
    if(any(c(H$dH.Hdt[-(1:10)], S$dS.Sdt[-(1:10)])<0)) abline(h=0, lwd=0.5, lty=3)
    text(time[0.95*length(time)], Hgrf, labels=as.character(round(Hgrf, 3)), pos=3, xpd=T, cex=0.75)
    #title("State variable dynamics", adj=0, cex.main=2, outer = T)
    title("Specific growth rates", adj=0, line=0.25)
    lines(time, S$dS.Sdt, col="black", lwd=1)
    legend("topright", legend=c("Host", "Sym"), lwd=c(2,1), col="black", bty="n", y.intersp=1, cex=0.75)
    
    # Light quenching (carbon fixation, NPQ, and excess (=ROS producing))
    plot(NA, xlim=range(time), xlab="", ylim=c(0,130), ylab="mol ph/CmolS/d")
    title("Light quenching", adj=0, line=0.25)
    lines(time, S$jCP/pars$yCL, col="gold", lwd=1) # amt. quenched by photosynthesis
    lines(time, S$jCP/pars$yCL + S$jNPQ, col="gold", lty=1, lwd=2) # amt. quenched by photo + NPQ
    lines(time, S$jL, col="gold", lty=3, lwd=2) # total amt. absorbed
    legend("topright", legend=c("ROS", "NPQ", "Photo."), lty=c(3,1,1), lwd=c(2,2,1), col="gold", bty="n", cex=0.75)

    # Photosynthesis: substrate-limitation
    pl <- log(   pmin((H$jCO2 + H$rCH)*H$H/S$S + S$rCS, pars$jCPm)   /   pmin(S$jL * pars$yCL, pars$jCPm)    )
    maxabs <- max(abs(pl))
    plot(NA, xlim=range(time), xlab="", ylab="", ylim=c(-0.8, 0.8))
    title("Photosynthesis: substrate-limitation", adj=0, line=0.25)
    lines(time, pl, col="black", lty=1, lwd=2)
    abline(h=0, lty=3)
    text(par("usr")[2], 0, labels="L-lim.\nCO2-lim.", cex=0.75, adj=1)
    
    # Biomass formation - substrate-limitation
    sl <- log(  pmin(S$jCP, pars$jSGm)   /   pmin((H$rhoN*H$H/S$S + S$rNS)/pars$nNS, pars$jSGm)  )
    hl <- log(  pmin(S$rhoC*S$S/H$H + H$jX, pars$jHGm) / pmin((H$jN + pars$nNX*H$jX + H$rNH) / pars$nNH, pars$jHGm)  )
    maxabs <- max(c(abs(hl), abs(sl)))
    range <- range(c(hl, sl))
    plot(NA, xlim=range(time), xlab="", ylab="", ylim=c(-1.5,1.5))
    title("Biomass: substrate-limitation", adj=0, line=0.25)
    lines(time, hl, col="black", lty=1, lwd=2)
    lines(time, sl, col="black", lty=1, lwd=1)
    abline(h=0, lty=3)
    text(par("usr")[2], 0, labels="N-lim.\nC-lim.", cex=0.75, adj=1)
    legend("topright", legend=c("Host", "Sym"), lty=1, lwd=c(2,1), col="black", bty="n", cex=0.75)
})
```

# Figure S9. Overshoot of symbiont density following bleaching.
```{r FigS9, cache=T}
# Set run time vector
time <- seq(-100, 1095, 0.5)  # if single model run, use time input

# Initialize environment
env <- init_env(time=time, L=c(60,20,4), N=c(2e-7,2e-7,0), X=c(2e-6,2e-6,0))

# Set parameters
defpars <- def_pars()  # Get default parameters

# Run simulation
run <- run_coral(time=time, env=env, pars=replace(defpars, "kCO2", 6))#
plot_run(run)
```

## References